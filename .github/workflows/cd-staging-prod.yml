name: CD Staging + Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # NOTE: There is a separate deploy workflow in .github/workflows/deploy.yml that
  # builds on the server. This CD workflow is the official TP2 pipeline.
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PHP dependencies
        run: composer install --no-dev --prefer-dist --no-interaction

      - name: Install Node dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Generate RELEASE_ID
        id: release
        shell: bash
        run: |
          set -e
          SHORT_SHA="$(git rev-parse --short HEAD)"
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            RELEASE_ID="${GITHUB_REF_NAME}-${SHORT_SHA}"
          else
            RELEASE_ID="$(date +%Y%m%d%H%M%S)-${SHORT_SHA}"
          fi
          echo "${RELEASE_ID}" > RELEASE_ID
          echo "release_id=${RELEASE_ID}" >> "$GITHUB_OUTPUT"

      - name: Package release artifact
        shell: bash
        run: |
          set -e
          tar -czf release.tgz \
            app \
            bootstrap \
            config \
            database \
            routes \
            resources \
            public/build \
            vendor \
            artisan \
            composer.json \
            composer.lock \
            RELEASE_ID

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: release.tgz

  deploy_staging:
    runs-on: self-hosted
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    environment: staging
    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_PORT: ${{ secrets.STAGING_PORT }}
      STAGING_APP_URL: ${{ vars.STAGING_APP_URL }}
      STAGING_APP_PATH: ${{ secrets.STAGING_APP_PATH }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release

      - name: Read RELEASE_ID
        id: release
        shell: bash
        run: |
          set -e
          echo "release_id=$(tar -xOf release.tgz RELEASE_ID)" >> "$GITHUB_OUTPUT"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          set -e
          PORT="${STAGING_PORT:-22}"
          ssh-keyscan -p "$PORT" "$STAGING_HOST" >> ~/.ssh/known_hosts

      - name: Upload release
        shell: bash
        run: |
          set -e
          PORT="${STAGING_PORT:-22}"
          rsync -az -e "ssh -p $PORT" release.tgz "$STAGING_USER@$STAGING_HOST:/tmp/comprasventas-release.tgz"

      - name: Deploy on staging
        shell: bash
        run: |
          set -e
          PORT="${STAGING_PORT:-22}"
          RELEASE_ID="${{ steps.release.outputs.release_id }}"
          APP_ROOT="$STAGING_APP_PATH"
          ssh -p "$PORT" "$STAGING_USER@$STAGING_HOST" \
            "APP_ROOT='$APP_ROOT' RELEASE_ID='$RELEASE_ID' bash -s" <<'EOF'
          set -e
          if [ ! -d "$APP_ROOT" ]; then
            echo "ERROR: APP_ROOT no existe: $APP_ROOT"
            exit 1
          fi
          RELEASE_DIR="$APP_ROOT/releases/$RELEASE_ID"
          mkdir -p "$RELEASE_DIR"
          tar -xzf /tmp/comprasventas-release.tgz -C "$RELEASE_DIR"
          ln -sfn "$APP_ROOT/shared/.env" "$RELEASE_DIR/.env"
          if [ -d "$APP_ROOT/shared/storage" ]; then
            ln -sfn "$APP_ROOT/shared/storage" "$RELEASE_DIR/storage"
          fi
          cd "$RELEASE_DIR"
          php artisan optimize:clear || true
          php artisan migrate --force
          ln -sfn "$RELEASE_DIR" "$APP_ROOT/current"
          EOF

      - name: Health gate
        shell: bash
        run: |
          set -e
          curl -fsS "${STAGING_APP_URL}/api/health"

  deploy_production:
    runs-on: self-hosted
    needs: deploy_staging
    if: ${{ (github.ref_type == 'tag' || github.event_name == 'workflow_dispatch') && needs.deploy_staging.result == 'success' }}
    environment: production
    env:
      PROD_HOST: ${{ secrets.PROD_HOST }}
      PROD_USER: ${{ secrets.PROD_USER }}
      PROD_PORT: ${{ secrets.PROD_PORT }}
      PROD_APP_URL: ${{ vars.PROD_APP_URL }}
      PROD_APP_PATH: ${{ secrets.PROD_APP_PATH }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release

      - name: Read RELEASE_ID
        id: release
        shell: bash
        run: |
          set -e
          echo "release_id=$(tar -xOf release.tgz RELEASE_ID)" >> "$GITHUB_OUTPUT"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          set -e
          PORT="${PROD_PORT:-22}"
          ssh-keyscan -p "$PORT" "$PROD_HOST" >> ~/.ssh/known_hosts

      - name: Upload release
        shell: bash
        run: |
          set -e
          PORT="${PROD_PORT:-22}"
          rsync -az -e "ssh -p $PORT" release.tgz "$PROD_USER@$PROD_HOST:/tmp/comprasventas-release.tgz"

      - name: Deploy on production
        shell: bash
        run: |
          set -e
          PORT="${PROD_PORT:-22}"
          RELEASE_ID="${{ steps.release.outputs.release_id }}"
          APP_ROOT="$PROD_APP_PATH"
          ssh -p "$PORT" "$PROD_USER@$PROD_HOST" \
            "APP_ROOT='$APP_ROOT' RELEASE_ID='$RELEASE_ID' bash -s" <<'EOF'
          set -e
          if [ ! -d "$APP_ROOT" ]; then
            echo "ERROR: APP_ROOT no existe: $APP_ROOT"
            exit 1
          fi
          RELEASE_DIR="$APP_ROOT/releases/$RELEASE_ID"
          mkdir -p "$RELEASE_DIR"
          tar -xzf /tmp/comprasventas-release.tgz -C "$RELEASE_DIR"
          ln -sfn "$APP_ROOT/shared/.env" "$RELEASE_DIR/.env"
          if [ -d "$APP_ROOT/shared/storage" ]; then
            ln -sfn "$APP_ROOT/shared/storage" "$RELEASE_DIR/storage"
          fi
          cd "$RELEASE_DIR"
          php artisan optimize:clear || true
          php artisan migrate --force
          ln -sfn "$RELEASE_DIR" "$APP_ROOT/current"
          EOF

      - name: Health gate
        shell: bash
        run: |
          set -e
          curl -fsS "$PROD_APP_URL/api/health"

  rollback_staging:
    runs-on: self-hosted
    needs: deploy_staging
    if: ${{ always() && needs.deploy_staging.result == 'failure' }}
    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_PORT: ${{ secrets.STAGING_PORT }}
      STAGING_APP_PATH: ${{ secrets.STAGING_APP_PATH }}
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          set -e
          PORT="${STAGING_PORT:-22}"
          ssh-keyscan -p "$PORT" "$STAGING_HOST" >> ~/.ssh/known_hosts

      - name: Rollback staging
        shell: bash
        run: |
          set -e
          PORT="${STAGING_PORT:-22}"
          APP_ROOT="$STAGING_APP_PATH"
          ssh -p "$PORT" "$STAGING_USER@$STAGING_HOST" \
            "APP_ROOT='$APP_ROOT' bash -s" <<'EOF'
          set -e
          if [ ! -d "$APP_ROOT/releases" ]; then
            echo "ERROR: releases no existe en $APP_ROOT"
            exit 1
          fi
          PREV="$(ls -1dt "$APP_ROOT/releases/"* 2>/dev/null | sed -n '2p')"
          if [ -z "$PREV" ]; then
            echo "ERROR: No hay release anterior para rollback"
            exit 1
          fi
          ln -sfn "$PREV" "$APP_ROOT/current"
          EOF

  rollback_production:
    runs-on: self-hosted
    needs: deploy_production
    if: ${{ always() && needs.deploy_production.result == 'failure' }}
    env:
      PROD_HOST: ${{ secrets.PROD_HOST }}
      PROD_USER: ${{ secrets.PROD_USER }}
      PROD_PORT: ${{ secrets.PROD_PORT }}
      PROD_APP_PATH: ${{ secrets.PROD_APP_PATH }}
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          set -e
          PORT="${PROD_PORT:-22}"
          ssh-keyscan -p "$PORT" "$PROD_HOST" >> ~/.ssh/known_hosts

      - name: Rollback production
        shell: bash
        run: |
          set -e
          PORT="${PROD_PORT:-22}"
          APP_ROOT="$PROD_APP_PATH"
          ssh -p "$PORT" "$PROD_USER@$PROD_HOST" \
            "APP_ROOT='$APP_ROOT' bash -s" <<'EOF'
          set -e
          if [ ! -d "$APP_ROOT/releases" ]; then
            echo "ERROR: releases no existe en $APP_ROOT"
            exit 1
          fi
          PREV="$(ls -1dt "$APP_ROOT/releases/"* 2>/dev/null | sed -n '2p')"
          if [ -z "$PREV" ]; then
            echo "ERROR: No hay release anterior para rollback"
            exit 1
          fi
          ln -sfn "$PREV" "$APP_ROOT/current"
          EOF
